<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" th:replace="~{admin/admin-layout :: admin_layout(~{::main})}">
<body>
<main>
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title" th:text="${item.id == null ? 'Thêm sản phẩm mới' : 'Chỉnh sửa sản phẩm'}">Thêm sản phẩm mới</h1>
        <div class="page-breadcrumb">
            <a href="/admin/dashboard"><i class="fas fa-home"></i> Dashboard</a> / 
            <a href="/admin/products">Sản phẩm</a> / 
            <span th:text="${item.id == null ? 'Thêm mới' : 'Chỉnh sửa'}">Thêm mới</span>
        </div>
    </div>

    <!-- Form Card -->
    <div class="admin-card">
        <div class="card-header-custom">
            <h5 class="card-title-custom">
                <i class="fas fa-edit me-2"></i>
                <span th:text="${item.id == null ? 'Thông tin sản phẩm mới' : 'Cập nhật thông tin'}">Thông tin sản phẩm mới</span>
            </h5>
        </div>

        <form th:action="@{/admin/product/save}" 
              th:object="${item}" 
              method="post" 
              enctype="multipart/form-data"
              class="needs-validation" 
              novalidate>
            
            <input type="hidden" th:field="*{id}">
            
            <div class="row">
                <!-- Left Column -->
                <div class="col-md-8">
                    <!-- Product Name -->
                    <div class="mb-3">
                        <label for="name" class="form-label">
                            Tên sản phẩm <span class="text-danger">*</span>
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="name" 
                               th:field="*{name}"
                               th:classappend="${#fields.hasErrors('name')} ? 'is-invalid' : ''"
                               placeholder="Nhập tên sản phẩm"
                               required>
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('name')}" th:errors="*{name}">
                            Vui lòng nhập tên sản phẩm
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="mb-3">
                        <label for="description" class="form-label">Mô tả sản phẩm</label>
                        <textarea class="form-control" 
                                  id="description" 
                                  th:field="*{description}"
                                  rows="5"
                                  placeholder="Nhập mô tả chi tiết về sản phẩm..."></textarea>
                    </div>

                    <!-- Price Row -->
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="price" class="form-label">
                                    Giá bán (VNĐ) <span class="text-danger">*</span>
                                </label>
                                <input type="number" 
                                       class="form-control" 
                                       id="price" 
                                       th:field="*{price}"
                                       th:classappend="${#fields.hasErrors('price')} ? 'is-invalid' : ''"
                                       placeholder="0"
                                       min="0"
                                       required>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('price')}" th:errors="*{price}">
                                    Vui lòng nhập giá sản phẩm
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Category & Status Row -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="category" class="form-label">
                                    Danh mục <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" 
                                        id="category" 
                                        th:field="*{category.id}"
                                        required>
                                    <option value="">-- Chọn danh mục --</option>
                                    <option th:each="cat : ${categories}" 
                                            th:value="${cat.id}" 
                                            th:text="${cat.name}">Category</option>
                                </select>
                                <div class="invalid-feedback">
                                    Vui lòng chọn danh mục
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="available" class="form-label">Trạng thái</label>
                                <select class="form-select" id="available" th:field="*{available}">
                                    <option th:value="true">Đang bán</option>
                                    <option th:value="false">Ngừng bán</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Image Upload -->
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">Hình ảnh sản phẩm</label>
                        
                        <!-- Image Preview -->
                        <div class="text-center mb-3">
                            <img id="imagePreview" 
                                 th:src="${item.image != null ? item.image : 'https://via.placeholder.com/300x300?text=No+Image'}"
                                 class="img-fluid rounded border"
                                 style="max-height: 300px; object-fit: cover;">
                        </div>

                        <!-- Upload Button -->
                        <input type="file" 
                               class="form-control" 
                               id="imageFile" 
                               name="imageFile"
                               accept="image/*"
                               onchange="previewImage(event)">
                        <small class="text-muted">Định dạng: JPG, PNG, GIF. Tối đa 2MB</small>
                        
                        <!-- Hidden field for existing image -->
                        <input type="hidden" th:field="*{image}">
                    </div>

                    <!-- Quick Info -->
                    <div class="alert alert-info" th:if="${item.id != null}">
                        <small>
                            <strong>Ngày tạo:</strong><br>
                            <span th:text="${#temporals.format(item.createDate, 'dd/MM/yyyy HH:mm')}">01/01/2026</span>
                        </small>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                <a href="/admin/products" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Quay lại
                </a>
                <div>
                    <button type="reset" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-redo me-2"></i>Làm mới
                    </button>
                    <button type="submit" class="btn btn-primary-custom">
                        <i class="fas fa-save me-2"></i>Lưu sản phẩm
                    </button>
                </div>
            </div>
        </form>
    </div>
</main>

<script>
    // Form validation
    (function() {
        'use strict';
        const forms = document.querySelectorAll('.needs-validation');
        Array.from(forms).forEach(form => {
            form.addEventListener('submit', event => {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    })();

    // Image preview
    function previewImage(event) {
        const file = event.target.files[0];
        if (file) {
            // Check file size (2MB)
            if (file.size > 2 * 1024 * 1024) {
                alert('Kích thước file quá lớn! Vui lòng chọn file nhỏ hơn 2MB.');
                event.target.value = '';
                return;
            }

            // Check file type
            if (!file.type.startsWith('image/')) {
                alert('Vui lòng chọn file hình ảnh!');
                event.target.value = '';
                return;
            }

            // Preview
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('imagePreview').src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    }

    // Format price input
    const priceInput = document.getElementById('price');
    if (priceInput) {
        priceInput.addEventListener('blur', function() {
            if (this.value) {
                this.value = Math.round(this.value);
            }
        });
    }
</script>
</body>
</html>
